---
title: "Demonstration of method"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, message = FALSE, warning = FALSE)
```

# Introduction 

This script sets out the method used to calculate $\tau$, and is used to generate the explanatory plots in 1a. 

```{r message = FALSE}
library(tidyverse)
library(broom)
library(cowplot)

read_csv('../TraitTables/bt_names_all_traits.csv' ) %>%
  rowwise %>% 
  mutate( HasTraits =   !all(is.na(TR_BodyLength_mm),
                             is.na(TR_QualitativeBodySize),
                             is.na(TR_Mean_LengthMax),
                             is.na(TR_adult_body_mass_g), 
                             is.na(TR_Mean_SeedMass ),
                             is.na(TR_Max_Height ))) %>%
  ungroup()-> CompleteTraitTable

bt_grid_collate_filter <-  read_csv('../BT_Tables/bt_grid_collate_filter_tidy.csv',
                                    col_types = cols(
                                      STUDY_ID_CELL = col_character(),
                                      STUDY_ID = col_double(),
                                      YEAR = col_double(),
                                      CrossCellAbundance = col_double(),
                                      CrossCellBiomass = col_double(),
                                      ABUNDANCE_TYPE = col_character(),
                                      BIOMASS_TYPE = col_character(),
                                      TidyBTName = col_character(),
                                      canonicalName = col_character(),
                                      rank = col_character(),
                                      kingdom = col_character())) 

bt_grid_collate_filter %>%
  left_join(CompleteTraitTable, 
            by = c('TidyBTName','canonicalName','rank','kingdom')) -> bt_with_traits


bt_with_traits %>% 
  group_by(STUDY_ID_CELL) %>%
  summarise(across(  starts_with('TR_'),    ~ mean(!is.na(.x)),
                     .names =  "Comp_{.col}"))%>%
  mutate( Best_Completeness = pmax(Comp_TR_BodyLength_mm,Comp_TR_QualitativeBodySize,
                                   Comp_TR_Mean_LengthMax, Comp_TR_adult_body_mass_g,
                                   Comp_TR_Mean_SeedMass, Comp_TR_Max_Height)) %>%
  ungroup()-> StudyCell_level_TC

```


## Demonstration of approach 

Picking a fairly random example assemblage to work with: Study 316, Cell 442925

```{r}
x<- bt_with_traits %>% filter( STUDY_ID_CELL =='316_442925')
x_traits <- distinct(x, TidyBTName, TR_adult_body_mass_g ) 
```

Plotting raw data, colouring time sreis by trait. 

```{r}
x %>%
  ggplot( aes( x=YEAR, y=CrossCellAbundance, 
               group =TidyBTName, 
               col =TR_adult_body_mass_g  ))+
  geom_point()+
  geom_line()+
  scale_y_log10()+
  ggtitle( 'Time series, coloured by trait')


```


Converting to relative ranks and standardising time. NB this normalisation is not strictly necessary, as the final calculation of $\tau$ uses a non-parametric correlation approach.

```{r}

StartYear = min(x$YEAR)
EndYear = max(x$YEAR)

x %>%
  group_by(YEAR) %>%
  summarise(RelRank =  rank(CrossCellAbundance ,  ties.method = "average")/n(),  Species =TidyBTName) %>% 
  arrange( YEAR, RelRank) %>%
  spread( YEAR, RelRank, fill = 0) %>%       #  fill in zeros, across all years not observed 
  gather( 'Year',  'RelRank', -Species  )%>%
  mutate( Year = as.numeric( Year),
          TimeStd =(Year-StartYear)/ (EndYear- StartYear))-> RelativeRankTimeSeries

RelativeRankTimeSeries%>%
  ggplot( aes( x=Year, y=RelRank, col = Species ))+
  geom_jitter(width = 0.2)+
  geom_line(linetype = 'dashed')+
  #  guides(col = FALSE)+
  ggtitle( 'Relative Rank series, coloured by species')+
  theme(legend.position = 'bottom')

```

Find change through time of relative ranks '$\beta$' by fitting linear models through the realtive ranks of each species. 

```{r}
SpeciesSlopes<- map_df( unique(RelativeRankTimeSeries$Species),  
                        RelativeRankTimeSeries,
                        .f= function( sp, df){
                          
                          df %>%
                            filter( Species == sp)%>%
                            lm(  RelRank ~ TimeStd,
                                 data =  .  ) %>% 
                            tidy() %>% 
                            filter( term == 'TimeStd') %>%
                            mutate( Species = sp) %>%
                            select( Slope = estimate, Species)%>%
                            return()
                        })

## Just to be tidy, set any very low values (i.e. flat lines) just to 0

SpeciesSlopes$Slope[abs(SpeciesSlopes$Slope) < 0.00001] <- 0

RelativeRankTimeSeries%>%
  left_join(x_traits, by = c('Species' ='TidyBTName')) %>%
  ggplot( aes( x=Year, y=RelRank, col = Species ))+
  geom_point()+
  geom_smooth(method = 'lm', se = FALSE)+
  guides(col = FALSE)


SpeciesSlopes %>%
  left_join(x_traits, by = c('Species' ='TidyBTName')) -> SpeciesSlopes
```


```{r}
SpeciesSlopes%>%
  ggplot( aes(x=Slope, y = Species, fill = TR_adult_body_mass_g))+
  geom_bar(stat = 'identity')
```


Finally, find correlation between $\beta$s and the trait values (for species that have trait values) 

```{r}
SpeciesSlopes %>%
  ggplot( aes(TR_adult_body_mass_g,  Slope)) +
  geom_point()


cor(SpeciesSlopes$TR_adult_body_mass_g, SpeciesSlopes$Slope, method = 'kendall', use = "na.or.complete")

```

#### Generating plots for Figure 1a
```{r}

DD <- RelativeRankTimeSeries%>%
  left_join(x_traits, by = c('Species' ='TidyBTName')) %>%
  left_join(SpeciesSlopes, by = c("Species", "TR_adult_body_mass_g")) 

NotNA_SS<- filter( SpeciesSlopes, !is.na( TR_adult_body_mass_g))


COLS<-data.frame(TidyBTName = NotNA_SS$Species,
                 Species = NotNA_SS$Species,
                 Colour = RColorBrewer::brewer.pal(10, 'Paired') )


x %>%
  select(YEAR,CrossCellAbundance, TidyBTName) %>%
  spread( YEAR, CrossCellAbundance, fill = 0) %>%       #  fill in zeros, across all years not observed 
  gather( 'YEAR',  'CrossCellAbundance', -TidyBTName  )%>% 
  left_join(COLS)%>%
  mutate( Colour = ifelse(is.na(Colour), 'black', Colour)) %>%
  ggplot( aes( x=as.numeric(YEAR), y=CrossCellAbundance, 
               group =TidyBTName,col = Colour ))+
  geom_point()+
  geom_line()+
  guides(col = FALSE)+
  scale_y_log10()+
  scale_color_identity()+
  # scale_color_viridis_d(direction = -1)+
  theme(panel.background = element_blank(), aspect.ratio=1)+
  theme_classic()+
  xlab('Year' )+
  ylab('Recorded Abundance')+
  ggtitle( 'i) Assemblage time series') -> Plot1

RelativeRankTimeSeries%>%
  left_join(x_traits, by = c('Species' ='TidyBTName')) %>%
  left_join(COLS)%>%
  mutate( Colour = ifelse(is.na(Colour), 'black', Colour)) %>%
  ggplot( aes( x=Year, y=RelRank, col = Colour, group = Species ))+
  scale_color_identity()+
  #scale_color_viridis_d(direction = -1)+
  geom_point()+
  theme_classic()+
  theme(panel.background = element_blank(), aspect.ratio=1)+
  geom_line()+
  guides(col = FALSE) +
  xlab('Year' )+
  ylab('Relative Rank')+
  ggtitle( 'ii) Relative ranks through time')-> Plot2


data.frame(Species = NotNA_SS$Species,
           AbundChangeRank=rank( NotNA_SS$Slope),
           TraitRank=rank( NotNA_SS$TR_adult_body_mass_g))%>%
  left_join(COLS)%>%
  ggplot( aes(TraitRank,  AbundChangeRank)) +
  #geom_label_repel(aes( label = Species, ),fontface = 'italic', seed = 20 )+ 
  theme_classic()+
  theme(panel.background = element_blank(),
        axis.text = element_blank(), 
        aspect.ratio=1)+
  geom_point( aes (col = Colour) , size = 4) +
  scale_color_identity()+
  xlab('Size-Trait Rank' )+
  ylab('Relative abundance change rank (β)')+
  ggtitle('iii) Trait-Rank trend correlation (τ)')-> Plot3


ThreeTogether <- plot_grid(Plot1, Plot2, Plot3, nrow = 1)
ThreeTogether
ggsave( '../Plots/MethodExplainer.png',ThreeTogether, height = 3.5,  width = 11)
ggsave( '../Plots/MethodExplainer.pdf',ThreeTogether, height = 3.5,  width = 11, device = cairo_pdf)

```

