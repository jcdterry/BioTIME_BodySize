---
title: "Extended Data"
output:
  pdf_document: 
    latex_engine: xelatex
  html_document:
    df_print: paged
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message = FALSE)
```

```{r }

########
## This Script outputs the Extended Data files as a single pdf. 
##########

library(tidyverse)
library(sjPlot)
library(knitr)
library(kableExtra)

```


**Extended Data Table 1** Full statistical results underlying Figure 2. Tests were two-sided Welch's two-sample t-tests, which approximates the relevant degrees of freedom given different variance in the observations and the null model. No corrections were made to the reported values for multiple comparisons.

```{r}

ttestsFull<- read_csv('../SIdata/T_tests.csv')

colnames(ttestsFull) <- c( "Trait",
                           "Difference"  ,      
                           "Lower CI","Upper CI"   ,                 
                           "(Observed)",
                           "(Null)" ,      
                           "t-statistic","p-value"       ,              
                           "of Freedom", 
                           "Size"     )

ttestsFull$Trait <-  c("Body Length","Qualitative Body Size",
                       "Maximum Length","Adult body mass",
                       "Seed Mass","Maximum Height" )      

ttestsFull %>%
  kable(digits = 4, booktabs = TRUE)%>%
  kable_styling(latex_options ="scale_down")%>%
  pack_rows("Marine", 1, 2)%>%
    pack_rows("Fish", 3,3)%>%
  pack_rows("Amniotes", 4,4)%>%
  pack_rows("Plants", 5,6) %>%
  add_header_above(c('',"Estimated", '', '', 
                     "Estimated Mean" =2 , '', '',
                     "Effective Degrees",
                     "Sample" ), line = FALSE, line_sep = 1) %>%
  column_spec(8,bold =  ttestsFull$`p-value`<0.05)


```

\newpage    

**Extended Data Figure 1** Raw relationships between the suite of study-level predictors and the principal response variable $\tau$.

![](../Plots/TauPredictorsPlot.png)

\newpage

**Extended Data Table 2** Full statistical results of linear models for the putative study-level drivers of $\tau$. Each trait was tested independently and no corrections were made to the reported values for multiple comparisons. There was no consistent drivers - only three relationships were identified as significant at p<0.05 (highlighted in **bold**), but these had low explanatory power. Inspection of Extended Data Figure 1 suggests that the impact of number of cells within the fish studies was driven by three outlier single-site studies, while the study-duration and sampling frequency relationships identified for plant height can be seen to be driven by one long term study. 


```{r}
## TableS2 # 

load('../SIdata/TableS2_dirty')

JustData<- as.data.frame(TableS2_dirty[,-1])


rownames(JustData ) <- c('Intercept', 'Species Richness', 'Trait Completeness' , 
                         'Years Sampled', 'Year Range', 
                         'Number of Cells (Log10)', 'Absolute Latitude' , 
                         'Observations' , 'Adjusted R-squared')

JustData%>%
  kbl( booktabs = TRUE,
       row.names = TRUE,
       col.names = rep(c('Estimate', 'p-value'), 6)) %>%
    kable_styling(latex_options ="scale_down")%>%
  add_header_above(c('',"Body Length" =2,
                     "Qualitative Body Size" =2 ,
                     "Maximum Length" =2, 
                     "Adult body mass" =2,
                     "Seed Mass" =2,
                     "Maximum Height"  =2 )) %>%
   add_header_above(c('',"Marine" =4,
                     "Fish" =2, 
                     "Amniotes" =2,
                     "Plants" =4 )) %>%
  column_spec(3 ,bold =  JustData[,2]<0.05) %>%
  column_spec(5 ,bold =  JustData[,4]<0.05) %>%
  column_spec(7 ,bold =  JustData[,6]<0.05) %>%
  column_spec(9 ,bold =  JustData[,8]<0.05) %>%
  column_spec(11,bold = JustData[,10]<0.05) %>%
  column_spec(13,bold = JustData[,12]<0.05)%>%
  pack_rows("Coefficents", 1, 7)%>%
  pack_rows("Summary", 8, 9)




```

\newpage

**Table S3** Full statistical results of tests for the drivers of $\tau^2$, in order to test if there are drivers for deviations from trait-neutrality. Each trait was tested independently and no corrections were made to the reported values for multiple comparisons. Here also, there were no consistent drivers.

```{r}
load('../SIdata/TableS3_dirty')

JustData<- as.data.frame(TableS3_dirty[,-1])

rownames(JustData ) <- c('Intercept', 'Species Richness', 'Trait Completeness' , 
                         'Years Sampled', 'Year Range', 
                         'Number of Cells (Log10)', 'Absolute Latitude' , 
                         'Observations' , 'Adjusted R-squared')

JustData%>%
  kbl( booktabs = TRUE,
       row.names = TRUE,
       col.names = rep(c('Estimate', 'p-value'), 6)) %>%
    kable_styling(latex_options ="scale_down")%>%
  add_header_above(c('',"Body Length" =2,
                     "Qualitative Body Size" =2 ,
                     "Maximum Length" =2, 
                     "Adult body mass" =2,
                     "Seed Mass" =2,
                     "Maximum Height"  =2 )) %>%
   add_header_above(c('',"Marine" =4,
                     "Fish" =2, 
                     "Amniotes" =2,
                     "Plants" =4 )) %>%
  column_spec(3 ,bold =  JustData[,2]<0.05) %>%
  column_spec(5 ,bold =  JustData[,4]<0.05) %>%
  column_spec(7 ,bold =  JustData[,6]<0.05) %>%
  column_spec(9 ,bold =  JustData[,8]<0.05) %>%
  column_spec(11,bold = JustData[,10]<0.05) %>%
  column_spec(13,bold = JustData[,12]<0.05)%>%
  pack_rows("Coefficents", 1, 7)%>%
  pack_rows("Summary", 8, 9)



```


\newpage


**Extended Data Figure 2** Further details of degree of overlap and correspondence between traits. a) Number of species that could be related to at least one trait from the four sources. b) Overlap within the WoRMS database between the quantitative and qualitative body lengths was relatively low. In cases where the data was available on both categories, the Spearman's rank correlation was 0.65. c) Very strong correlation between the size traits for species that had data in both the WoRMS and the FishBase databases. d) Overlap in trait data between then plant species held in the TRY database was comparatively high. e) Correlation between the seed mass and vegetative height trait values was moderate, and considerably less within guilds. 

```{r}
include_graphics(path = "../Plots/Venn_GoodLabels.pdf")
```

\newpage
**Extended Data Table 4** - List of studies used from BioTIME, including key statistics and description. Studies are ordered by trait, then by $\tau$. If a study could be linked to multiple traits, it will therefore appear multiple times.  Note this table is also available in .csv format. ID numbers correspond to the BioTIME database, and columns 'Latitude' to 'Data Source' are directly drawn from the BioTIME metadata. 


```{r}

read_csv('../Results/Study_Corr_Predictors.csv')%>%
  left_join(select( read_csv('../BT_Tables/BioTIMEMetadata_02_04_2018.csv'), STUDY_ID, WEB_LINK), by = "STUDY_ID") %>%
  arrange( trait, Mean_kendall_cor) %>%
  mutate( trait = recode(trait , "TR_BodyLength_mm"="Marine:  Body Length",
                         "TR_QualBS_Numeric" = "Marine: Qualitative Body Size" ,
                         "TR_Mean_LengthMax"= "Fish: Maximum Length", 
                         "TR_adult_body_mass_g"= "Amniotes:Adult body mass",
                         "TR_Mean_SeedMass"="Plants: Seed Mass",
                         "TR_Max_Height"="Plants: Maximum Height"  ))%>%
  mutate( GRAIN_SQ_KM = ifelse(GRAIN_SQ_KM==-Inf, 0, 10^(GRAIN_SQ_KM)))%>%
  mutate(Mean_YearRange = round(Mean_YearRange,1),
         Mean_Sp_div = round(Mean_Sp_div,1),
         Mean_Completeness = round(Mean_Completeness*100),2) %>%
  select('Trait tested' = trait,
         'ID' = STUDY_ID ,
         'tau' =Mean_kendall_cor ,
         'N. Sp.' = Mean_Sp_div,
         'N. Years'  =Mean_N_Years,
         'Trait %'= Mean_Completeness ,
         'Year Span' = Mean_YearRange ,
         'N. Cells' = Cells,
         'Latitude' = CENT_LAT, 
         'Longitude' = CENT_LONG,
         'Grain' = GRAIN_SQ_KM,
         'Abundance' = ABUNDANCE_TYPE, 
         'Biomass' = BIOMASS_TYPE,
         'Study Title' = TITLE,
         'Data Source' = WEB_LINK )%>%
  kbl(digits = 3, longtable = TRUE, ) %>%
  kable_styling(latex_options =c("repeat_header"), font_size =5) %>% 
  landscape()%>%
  column_spec(14, width = "15em" )%>%
    column_spec(15, width = "10em" )%>%
  column_spec(4, width = "5em") %>%
  column_spec(1, width = "10em")


```